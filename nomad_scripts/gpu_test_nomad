job "homelab-gpu-mandelbrot" {
  datacenters = ["dc1"]
  type        = "batch"

  # --- GROUP 1: JETSON ORIN (JetPack 6) ---
  group "orin-group" {
    constraint {
      attribute = "${meta.jetpack_version}"
      value     = "6.x"
    }
    task "mandelbrot-orin" {
      driver = "docker"
      config {
        image   = "nvcr.io/nvidia/l4t-base:r36.2.0"
        runtime = "nvidia"
        mount {
          type = "bind"
          source = "/clusterfs"
          target = "/app"
          readonly = false
        }
        command = "/bin/bash"
        args    = ["-c", "chmod +x /app/HPC_development/homelab-heterogenous-HPC/bin/arm/bin_orin/gpu/mandelbrot_load_balanced_cuda && /app/HPC_development/homelab-heterogenous-HPC/bin/arm/bin_orin/gpu/mandelbrot_load_balanced_cuda"]
      }
    }
  }

  # --- GROUP 2: JETSON NANO (JetPack 4) ---
  group "nano-group" {
    constraint {
      attribute = "${meta.jetpack_version}"
      value     = "4.x"
    }
    task "mandelbrot-nano" {
      driver = "docker"
      config {
        image   = "nvcr.io/nvidia/l4t-base:r32.7.1"
        runtime = "nvidia"
        mount {
          type = "bind"
          source = "/clusterfs"
          target = "/app"
          readonly = false
        }
        command = "/bin/bash"
        args    = ["-c", "chmod +x /app/HPC_development/homelab-heterogenous-HPC/bin/arm/bin_nano/gpu/mandelbrot_load_balanced_cuda && /app/HPC_development/homelab-heterogenous-HPC/bin/arm/bin_nano/gpu/mandelbrot_load_balanced_cuda"]
      }
    }
  }

  # --- GROUP 3: INTEL NUC (Iris GPU) ---
  group "nuc-group" {
    constraint {
      attribute = "${meta.gpu_type}"
      value     = "intel_iris"
    }
    task "mandelbrot-intel" {
      driver = "docker"
      config {
        image = "ubuntu:22.04"
        
        # Pass Intel GPU devices to the container
        devices = [
          {
            host_path      = "/dev/dri"
            container_path = "/dev/dri"
          }
        ]
        mount {
          type = "bind"
          source = "/clusterfs"
          target = "/app"
          readonly = false
        }
        command = "/bin/bash"
        args    = ["-c", "chmod +x /app/HPC_development/homelab-heterogenous-HPC/bin/x86_64/gpu/mandelbrot_load_balanced_sycl && /app/HPC_development/homelab-heterogenous-HPC/bin/x86_64/gpu/mandelbrot_load_balanced_sycl"]
      }
    }
  }
}